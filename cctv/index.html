<!doctype html>
<html lang="en">

<head>
    <title>CCTV</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="./js/hls.js"></script>
</head>

<body>
    <div class="container">
        <div class="header clearfix">
            <div class="row">
                <h3 class="col text-muted">CCTV</h3>
            </div>
        </div>

        <div id="hls-viewer">

        </div>

        <div class="jumbotron">
            <div class="col-sm-12 form-group">
                <video id="remoteVideo" autoplay controls playsinline></video>
            </div>
            <div class="form-group col-sm-12 text-left">
                <input type="text" class="form-control" id="streamName" placeholder="Type stream name">
            </div>
            <div class="form-group col-sm-12 text-left options">
                <div class="dropdown">
                    <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Resolution
                    </button>
                    <div id="dropdownMenu" class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                        <a class="dropdown-item active" href="#">Automatic</a>
                    </div>
                </div>
                <div class="dropdown-divider"></div>
            </div>

            <div class="form-group">
                <button class="btn btn-primary" id="start_play_button">Start Playing</button>
                <button class="btn btn-primary" id="stop_play_button">Stop Playing</button>
            </div>
            
            <span class="badge badge-warning" id="bitrateInfo" style="font-size:14px;display:none"
                style="display: none">Weak Network Connection</span>

        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        crossorigin="anonymous"></script>

</body>
<script type="module">
    import { WebRTCAdaptor } from "./js/webrtc_adaptor.js"
    import { CctvAdaptor } from "./js/cctvAdaptor.js"

    var cctvAdaptor = new CctvAdaptor({
        hlsStream: "http://192.168.41.195:5080/LiveApp/streams/18HLS.m3u8",
        webRtcSignalingServer: "ws://192.168.41.195:5080/WebRTCAppEE/websocket",
    });

    //$("#hls-viewer").append(cctvAdaptor.getHlsVideo());

    var start_play_button = document.getElementById("start_play_button");
    start_play_button.addEventListener("click", startPlaying, false)
    var stop_play_button = document.getElementById("stop_play_button");
    stop_play_button.addEventListener("click", stopPlaying, false);

    var streamNameBox = document.getElementById("streamName")
    streamNameBox.defaultValue = "stream1";

    var streamId;

    function startPlaying() {
        streamId = streamNameBox.value;
        webRTCAdaptor.play(streamNameBox.value, null);
    }

    function stopPlaying() {
        webRTCAdaptor.stop(streamId);
    }

    var pc_config = {
        'iceServers': [{
            'urls': 'stun:stun1.l.google.com:19302'
        }]
    };

    var sdpConstraints = {
        OfferToReceiveAudio: true,
        OfferToReceiveVideo: true
    };

    var mediaConstraints = {
        video: false,
        audio: false
    };

    var path = "192.168.41.195:5080/WebRTCAppEE/websocket";
    var websocketURL = "ws://" + path;

    if (location.protocol.startsWith("https")) {
        websocketURL = "wss://" + path;
    }

    function startAnimation() {
        $("#bitrateInfo").fadeIn(800, function () {
            $("#bitrateInfo").fadeOut(800, function () {
                $("#bitrateInfo").html("Weak Network Connection");
            });
        });
    }

    var webRTCAdaptor = new WebRTCAdaptor({
        websocket_url: websocketURL,
        mediaConstraints: mediaConstraints,
        peerconnection_config: pc_config,
        sdp_constraints: sdpConstraints,
        remoteVideoId: "remoteVideo",
        isPlayMode: true,
        debug: true,
        candidateTypes: ["tcp", "udp"],
        callback: function (info, obj) {
            console.debug(obj);
            if (info == "initialized") {
                console.log("initialized");
                start_play_button.disabled = false;
                stop_play_button.disabled = true;
            } else if (info == "play_started") {
                //joined the stream
                console.log("play started");
                start_play_button.disabled = true;
                stop_play_button.disabled = false;
                webRTCAdaptor.getStreamInfo(streamId);
                webRTCAdaptor.enableStats(obj.streamId);

            } else if (info == "play_finished") {
                //leaved the stream
                console.log("play finished");
                start_play_button.disabled = false;
                stop_play_button.disabled = true;
                $("#stats_panel").hide();
                // Reset stream resolutions in dropdown
                document.getElementById("dropdownMenu").innerHTML = '<a class="dropdown-item active" href="#">Automatic</a>';
            } else if (info == "closed") {
                //console.log("Connection closed");
                if (typeof obj != "undefined") {
                    console.log("Connecton closed: "
                        + JSON.stringify(obj));
                }
            } else if (info == "streamInformation") {

                var streamResolutions = new Array();

                obj["streamInfo"].forEach(function (entry) {
                    //It's needs to both of VP8 and H264. So it can be dublicate
                    if (!streamResolutions.includes(entry["streamHeight"])) {
                        streamResolutions.push(entry["streamHeight"]);
                    }
                });
                // Sort stream resolutions for good UI :)
                streamResolutions = streamResolutions.sort(function (a, b) { return a - b });

                // Add stream resolutions in dropdown menu
                const dropdownMenu = document.querySelector('.dropdown-menu');

                streamResolutions.forEach(streamResolution => {
                    dropdownMenu.innerHTML += '<a class="dropdown-item" href="#">' + streamResolution + 'p</a>';
                });

                $('.dropdown-menu a').click(function () {
                    var dropdownSelectedItem = $(this).text();

                    if (dropdownSelectedItem == "Automatic") {
                        dropdownSelectedItem = 0;
                    }

                    // Remove p character in stream resolution
                    dropdownSelectedItem = dropdownSelectedItem.replace('p', '');

                    // Call set stream resolution
                    webRTCAdaptor.forceStreamQuality(streamId, Number(dropdownSelectedItem));
                    // Remove current active item
                    $('a.dropdown-item.active').removeClass("active");
                    // Add active in new item
                    $(this).addClass("active");
                });
            }
            else if (info == "ice_connection_state_changed") {
                console.log("iceConnectionState Changed: ", JSON.stringify(obj));
            }
            else if (info == "updated_stats") {
                console.debug("Average incoming kbits/sec: " + obj.averageIncomingBitrate
                    + " Current incoming kbits/sec: " + obj.currentIncomingBitrate
                    + " video packetLost: " + obj.videoPacketsLost
                    + " audio packetLost: " + obj.audioPacketsLost
                    + " frame width: " + obj.frameWidth
                    + " frame height: " + obj.frameHeight
                    + " frame received: " + obj.framesReceived
                    + " frame decoded: " + obj.framesDecoded
                    + " frame dropped: " + obj.framesDropped
                    + " video jitter average delay: " + obj.videoJitterAverageDelay
                    + " audio jitter average delay: " + obj.audioJitterAverageDelay
                    + " audio level: " + obj.audioLevel);
            }
            else if (info == "data_received") {
                console.log("Data received: " + obj.event.data + " type: " + obj.event.type + " for stream: " + obj.streamId);
            }
            else if (info == "bitrateMeasurement") {

                console.debug(obj);
                if (obj.audioBitrate + obj.videoBitrate > obj.targetBitrate) {
                    startAnimation();
                }
            }
            else {
                console.debug(info + " notification received");
            }
        },
        callbackError: function (error) {
            console.log("error callback: " + JSON.stringify(error));
            alert(JSON.stringify(error));
        }
    });

    window.webRTCAdaptor = webRTCAdaptor;
</script>

</html>